<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>포켓몬 쇼다운 클론</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        /* 간단한 화면 전환 스타일 */
        .screen { display: none; }
        .active { display: block; }
        
        /* 로비 스타일 */
        #lobby-screen { text-align: center; margin-top: 100px; }
        input { padding: 10px; font-size: 16px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        
        /* 게임 로그 등 기존 스타일 */
        #messages { list-style-type: none; margin: 0; padding: 0; border-top: 1px solid #ccc; margin-top: 20px;}
        #messages li { padding: 5px 10px; }
        #messages li:nth-child(odd) { background: #eee; }
    </style>
</head>
<body>

    <div id="lobby-screen" class="screen active">
        <h1>포켓몬 쇼다운 로비</h1>
        <p>입장할 방 이름을 입력하세요 (친구와 같은 이름을 쓰세요!)</p>
        <input type="text" id="room-input" placeholder="예: 초보만" />
        <button id="btn-join">입장하기</button>
    </div>

    <div id="game-screen" class="screen">
        <h1>포켓몬 쇼다운 - 대기 중</h1>
        
        <div style="display: flex; gap: 50px; margin-bottom: 20px;">
            <div id="p1-status" style="border: 1px solid #ccc; padding: 10px; min-width: 150px;">
                <h3>Player 1</h3>
                <div id="p1-name">?</div>
                <div id="p1-hp">HP: ? / ?</div>
            </div>
            <div id="p2-status" style="border: 1px solid #ccc; padding: 10px; min-width: 150px;">
                <h3>Player 2</h3>
                <div id="p2-name">?</div>
                <div id="p2-hp">HP: ? / ?</div>
            </div>
            
        </div>

        <div id="controls-area" style="margin: 20px 0; padding: 10px; border: 2px dashed #888;">
            <h4>기술 선택</h4>
            <div id="move-buttons" style="display: flex; gap: 10px;"></div>
            <h4>교체</h4>
            <div id="change-button" style="display: flex; gap: 10px;"></div>
            <h4>선택 취소</h4>
            <div id="discard-button" style="display: flex; gap: 10px;"></div>
        </div>

        <div id="party-panel" style="display: none;">
            <h4>교체할 포켓몬 선택</h4>
            <div id="change-button" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
            <button id="btn-cancel-switch" style="margin-top: 10px;">취소</button>
        </div>
        

        <hr>
        <h3>전투 로그</h3>
        <ul id="messages"></ul>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // 화면 요소들
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const roomInput = document.getElementById('room-input');
        const btnJoin = document.getElementById('btn-join');
        const gameTitle = document.querySelector('#game-screen h1');

        // 게임 UI 요소들
        const p1Name = document.getElementById('p1-name');
        const p1Hp = document.getElementById('p1-hp');
        const p2Name = document.getElementById('p2-name');
        const p2Hp = document.getElementById('p2-hp');
        const moveButtonsContainer = document.getElementById('move-buttons');
        const switchButton = document.getElementById("change-button"); // 수정
        const discardButton = document.getElementById("discard-button"); // 수정 2
        const messages = document.getElementById('messages');

        const attackPanel = document.getElementById('attack-panel'); // 토글 UI
        const partyPanel = document.getElementById('party-panel');
        const btnShowAttack = document.getElementById('btn-show-attack');
        const btnShowParty = document.getElementById('btn-show-party');
        const btnCancelSwitch = document.getElementById('btn-cancel-switch');

        let myRole = ''; 

        // ★ [로비] 입장 버튼 클릭 시
        btnJoin.addEventListener('click', () => {
            const roomId = roomInput.value.trim();
            if(!roomId) {
                alert("방 이름을 입력해주세요!");
                return;
            }
            // 서버에 입장 요청 전송
            socket.emit('join_game', roomId);
        });

        // ★ [게임] 역할 할당받으면 화면 전환
        socket.on('role_assigned', (data) => {
            myRole = data.role;
            const currentRoomId = data.roomId; // 서버가 같이 보내주게 수정했음

            // 1. 화면 전환 (로비 숨기기, 게임 보이기)
            lobbyScreen.classList.remove('active');
            gameScreen.classList.add('active');

            // 2. 제목 설정
            let roleText = "관전자 Mode";
            if (myRole === 'p1') roleText = "Player 1 (피카츄)";
            else if (myRole === 'p2') roleText = "Player 2 (파이리)";
            
            gameTitle.innerText = `[${currentRoomId}번 방] - ${roleText}`;
        });

         socket.on('update_ui', (data) => {
            if (data.p1.active) {
                p1Name.innerText = data.p1.active.name;
                p1Hp.innerText = `HP: ${data.p1.active.hp} / ${data.p1.active.maxHp}`;
            }
            if (data.p2.active) {
                p2Name.innerText = data.p2.active.name;
                p2Hp.innerText = `HP: ${data.p2.active.hp} / ${data.p2.active.maxHp}`;
            }

            moveButtonsContainer.innerHTML = ''; 
            switchButton.innerHTML = '';
            discardButton.innerHTML = '';
            
            let myMoves = [];
            if (myRole === 'p1' && data.p1.active) myMoves = data.p1.active.moves;
            else if (myRole === 'p2' && data.p2.active) myMoves = data.p2.active.moves;
            else {
                if(myRole === '') moveButtonsContainer.innerText = "로딩 중...";
                else moveButtonsContainer.innerText = "관전 중입니다.";
                return;
            }

            let myParty = [] // 이게 맞는지는 잘 모르겠다
            if (myRole === 'p1' && data.p1.party) myParty = data.p1.party;
            else if (myRole === 'p2' && data.p2.party) myParty = data.p2.party;
            else return;
            

            if (myMoves) {
                myMoves.forEach((move, Moveindex) => {
                    const btn = document.createElement('button');
                    btn.innerText = `${move.name}\n(${move.power})`;
                    btn.style.padding = '10px';
                    btn.style.marginRight = '5px';
                    btn.style.cursor = 'pointer';

                    btn.onclick = () => {
                        socket.emit('action', { type: 'move', index: Moveindex });
                    };
                    moveButtonsContainer.appendChild(btn);
                });
                const Chbtn = document.createElement('button');
                Chbtn.innerText = `교체`;
                Chbtn.style.padding = '10px';
                Chbtn.style.marginRight = '5px';
                Chbtn.style.cursor = 'pointer';
                Chbtn.onclick = () => {
                    if (myParty)
                    {
                        myParty.forEach((pokemon, entryindex) => {
                            const Pokebtn = document.createElement('button');
                            Pokebtn.innerText = `${pokemon.name}\n(${pokemon.hp}/${pokemon.maxHp})`;
                            Pokebtn.style.padding = '10px';
                            Pokebtn.style.marginRight = '5px';
                            Pokebtn.style.cursor = 'pointer';
                            Pokebtn.onclick = () => {
                                socket.emit('action', { type: 'switch', index: entryindex });
                            };
                            switchButton.appendChild(Pokebtn);
                        });
                    }
                };
                switchButton.appendChild(Chbtn);

                const Disbtn = document.createElement('button');
                Disbtn.innerText = `교체`;
                Disbtn.style.padding = '10px';
                Disbtn.style.marginRight = '5px';
                Disbtn.style.cursor = 'pointer';
                Disbtn.onclick = () => {
                        io.to(socketId).emit('move_discarded');
                };
                discardButton.appendChild(Disbtn);
                Disbtn.disabled = true;
            }
        });

        socket.on('chat message', (msg) => {
            const item = document.createElement('li');
            item.textContent = msg;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('input_locked', () => {
            const buttons = moveButtonsContainer.querySelectorAll('button'); // >< 버튼 활성화/비활성화 코드
            buttons.forEach(btn => btn.disabled = true);
            Chbtn.disabled = true;
            Disbtn.disabled = false;
            const li = document.createElement('li');
            li.style.color = "blue";
            li.textContent = "⏳ 입력 완료! 상대방 기다리는 중...";
            messages.appendChild(li);
        });

        socket.on('move_discarded',() =>{
            const buttons = moveButtonsContainer.querySelectorAll('button'); // >< 버튼 활성화/비활성화 코드
            buttons.forEach(btn => btn.disabled = false);
            Chbtn.disabled = false;
            Disbtn.disabled = true;
            const li = document.createElement('li');
            li.style.color = "blue";
            li.textContent = "입력을 취소하였습니다."
            messages.appendChild(li);
        });

        socket.on('turn_start', () => {
            const buttons = moveButtonsContainer.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = false); // >< 버튼 활성화/비활성화 코드

            const switchBtns = switchButton.querySelectorAll('button');
        switchBtns.forEach(btn => btn.disabled = false);
        });

        // [공격] 버튼 클릭 시
        btnShowAttack.addEventListener('click', () => {
            attackPanel.style.display = 'block';
            partyPanel.style.display = 'none';
        });

        // [포켓몬] 버튼 클릭 시
        btnShowParty.addEventListener('click', () => {
            attackPanel.style.display = 'none';
            partyPanel.style.display = 'block';
        });

        // 교체 패널 안의 [취소] 버튼
        btnCancelSwitch.addEventListener('click', () => {
            attackPanel.style.display = 'block';
            partyPanel.style.display = 'none';
        });
    </script>
</body>
</html>