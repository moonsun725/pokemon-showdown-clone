<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í¬ì¼“ëª¬ ì‡¼ë‹¤ìš´ í´ë¡ </title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        /* ê°„ë‹¨í•œ í™”ë©´ ì „í™˜ ìŠ¤íƒ€ì¼ */
        .screen { display: none; }
        .active { display: block; }
        
        /* ë¡œë¹„ ìŠ¤íƒ€ì¼ */
        #lobby-screen { text-align: center; margin-top: 100px; }
        input { padding: 10px; font-size: 16px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        
        /* ê²Œì„ ë¡œê·¸ ë“± ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
        #messages { list-style-type: none; margin: 0; padding: 0; border-top: 1px solid #ccc; margin-top: 20px;}
        #messages li { padding: 5px 10px; }
        #messages li:nth-child(odd) { background: #eee; }
    </style>
</head>
<body>

    <div id="lobby-screen" class="screen active">
        <h1>í¬ì¼“ëª¬ ì‡¼ë‹¤ìš´ ë¡œë¹„</h1>
        <p>ì…ì¥í•  ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì¹œêµ¬ì™€ ê°™ì€ ì´ë¦„ì„ ì“°ì„¸ìš”!)</p>
        <input type="text" id="room-input" placeholder="ì˜ˆ: ì´ˆë³´ë§Œ" />
        <button id="btn-join">ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="game-screen" class="screen">
        <h1>í¬ì¼“ëª¬ ì‡¼ë‹¤ìš´ - ëŒ€ê¸° ì¤‘</h1>
        
        <div style="display: flex; gap: 50px; margin-bottom: 20px;">
            <div id="p1-status" style="border: 1px solid #ccc; padding: 10px; min-width: 150px;">
                <h3>Player 1</h3>
                <div id="p1-name">?</div>
                <div id="p1-hp">HP: ? / ?</div>
            </div>
            <div id="p2-status" style="border: 1px solid #ccc; padding: 10px; min-width: 150px;">
                <h3>Player 2</h3>
                <div id="p2-name">?</div>
                <div id="p2-hp">HP: ? / ?</div>
            </div>
            
        </div>
        <div id="main-menu" style="margin-bottom: 10px;">
            <button id="btn-show-attack" style="width: 45%;">âš”ï¸ ê¸°ìˆ </button>
            <button id="btn-show-party" style="width: 45%;">ğŸ‘œ êµì²´</button>
        </div>

        <div id="controls-area" style="margin: 20px 0; padding: 10px; border: 2px dashed #888;">
            
            <div id="attack-panel">
                <h4>ê¸°ìˆ  ì„ íƒ</h4>
                <div id="move-buttons" style="display: flex; gap: 10px;"></div>
                
                <h4>ì„ íƒ ì·¨ì†Œ</h4>
                <div id="discard-button"></div>
            </div>

            <div id="party-panel" style="display: none;">
                <h4>êµì²´í•  í¬ì¼“ëª¬ ì„ íƒ</h4>
                <div id="change-button" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
                <button id="btn-cancel-switch" style="margin-top: 10px;">ë‹«ê¸°</button>
            </div>

        </div>
        <hr>
        <h3>ì „íˆ¬ ë¡œê·¸</h3>
        <ul id="messages"></ul>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // í™”ë©´ ìš”ì†Œë“¤
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const roomInput = document.getElementById('room-input');
        const btnJoin = document.getElementById('btn-join');
        const gameTitle = document.querySelector('#game-screen h1');

        // ê²Œì„ UI ìš”ì†Œë“¤
        const p1Name = document.getElementById('p1-name');
        const p1Hp = document.getElementById('p1-hp');
        const p2Name = document.getElementById('p2-name');
        const p2Hp = document.getElementById('p2-hp');
        const moveButtonsContainer = document.getElementById('move-buttons');
        const switchButton = document.getElementById("change-button"); // ìˆ˜ì •
        const discardButton = document.getElementById("discard-button"); // ìˆ˜ì • 2
        const messages = document.getElementById('messages');

        const attackPanel = document.getElementById('attack-panel'); // í† ê¸€ UI
        const partyPanel = document.getElementById('party-panel');
        const btnShowAttack = document.getElementById('btn-show-attack');
        const btnShowParty = document.getElementById('btn-show-party');
        const btnCancelSwitch = document.getElementById('btn-cancel-switch');

        let myRole = ''; 

        // â˜… [ë¡œë¹„] ì…ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
        btnJoin.addEventListener('click', () => {
            const roomId = roomInput.value.trim();
            if(!roomId) {
                alert("ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            // ì„œë²„ì— ì…ì¥ ìš”ì²­ ì „ì†¡
            socket.emit('join_game', roomId);
        });

        // â˜… [ê²Œì„] ì—­í•  í• ë‹¹ë°›ìœ¼ë©´ í™”ë©´ ì „í™˜
        socket.on('role_assigned', (data) => {
            myRole = data.role;
            const currentRoomId = data.roomId; // ì„œë²„ê°€ ê°™ì´ ë³´ë‚´ì£¼ê²Œ ìˆ˜ì •í–ˆìŒ

            // 1. í™”ë©´ ì „í™˜ (ë¡œë¹„ ìˆ¨ê¸°ê¸°, ê²Œì„ ë³´ì´ê¸°)
            lobbyScreen.classList.remove('active');
            gameScreen.classList.add('active');

            // 2. ì œëª© ì„¤ì •
            let roleText = "ê´€ì „ì Mode";
            if (myRole === 'p1') roleText = "Player 1 (í”¼ì¹´ì¸„)";
            else if (myRole === 'p2') roleText = "Player 2 (íŒŒì´ë¦¬)";
            
            gameTitle.innerText = `[${currentRoomId}ë²ˆ ë°©] - ${roleText}`;
        });

         socket.on('update_ui', (data) => {

            const gameState = data.gameState; 
            const faintId = data.faintPlayerId; // (í•„ìš”í•˜ë©´ ì‚¬ìš©)

             // (ì„ íƒì‚¬í•­) ë””ë²„ê¹…ìš©: ì½˜ì†”ì´ë‚˜ í™”ë©´ êµ¬ì„ì— ìƒíƒœ í‘œì‹œ
             console.log(`Current State: ${gameState}`);

            if (data.p1.active) {
                p1Name.innerText = data.p1.active.name;
                p1Hp.innerText = `HP: ${data.p1.active.hp} / ${data.p1.active.maxHp}`;
            }
            if (data.p2.active) {
                p2Name.innerText = data.p2.active.name;
                p2Hp.innerText = `HP: ${data.p2.active.hp} / ${data.p2.active.maxHp}`;
            }

            moveButtonsContainer.innerHTML = ''; 
            switchButton.innerHTML = '';
            discardButton.innerHTML = '';
            
            let myMoves = [];
            if (myRole === 'p1' && data.p1.active) myMoves = data.p1.active.moves;
            else if (myRole === 'p2' && data.p2.active) myMoves = data.p2.active.moves;
            else {
                if(myRole === '') moveButtonsContainer.innerText = "ë¡œë”© ì¤‘...";
                else moveButtonsContainer.innerText = "ê´€ì „ ì¤‘ì…ë‹ˆë‹¤.";
                return;
            }

            let myParty = [] // ì´ê²Œ ë§ëŠ”ì§€ëŠ” ì˜ ëª¨ë¥´ê² ë‹¤
            if (myRole === 'p1' && data.p1.party) myParty = data.p1.party;
            else if (myRole === 'p2' && data.p2.party) myParty = data.p2.party;
            else return;
            
            if (gameState === 'FORCE_SWITCH') {
                // êµì²´ ê°•ì œ ìƒíƒœë¼ë©´?
                // 1) ê³µê²© íŒ¨ë„ ìˆ¨ê¹€, êµì²´ íŒ¨ë„ ë³´ì„
                attackPanel.style.display = 'none';
                partyPanel.style.display = 'block';
                
                // 2) íƒ­ ì „í™˜ ë²„íŠ¼ì´ë‚˜ ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê²¨ë²„ë¦¬ê¸° (ëª» ë„ë§ê°€ê²Œ)
                btnShowAttack.disabled = true; 
                btnCancelSwitch.style.display = 'none'; // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¹€
                
                // ì•ˆë‚´ ë©”ì‹œì§€
                if (myRole === 'p1' && faintId === data.p1.id) { // ë‚´ ì•„ì´ë””ë‘ ë¹„êµí•´ì•¼ í•˜ëŠ”ë° ì—¬ê¸°ì„  ë¡œì§ì´ ì¢€ ë³µì¡í•  ìˆ˜ ìˆìŒ
                    // ì¼ë‹¨ ê°„ë‹¨íˆ ë©”ì‹œì§€ ì²˜ë¦¬
                }
            } else {
                // í‰ìƒì‹œì—” ë‹¤ì‹œ ë²„íŠ¼ í™œì„±í™”
                btnShowAttack.disabled = false;
                btnCancelSwitch.style.display = 'inline-block';
            }

            if (myMoves) {
                myMoves.forEach((move, Moveindex) => {
                    const btn = document.createElement('button');
                    btn.innerText = `${move.name}\n(${move.power})`;
                    btn.style.padding = '10px';
                    btn.style.marginRight = '5px';
                    btn.style.cursor = 'pointer';

                    btn.onclick = () => {
                        console.log(`[index.html]/[MoveBtn.onclick]: emit 'action' (move: ${Moveindex})`);
                        socket.emit('action', { type: 'move', index: Moveindex });
                    };
                    moveButtonsContainer.appendChild(btn);
                });
                const Chbtn = document.createElement('button');
                Chbtn.innerText = `êµì²´`;
                Chbtn.style.padding = '10px';
                Chbtn.style.marginRight = '5px';
                Chbtn.style.cursor = 'pointer';
                Chbtn.onclick = () => {
                    if (myParty)
                    {
                        switchButton.innerHTML = '';
                        myParty.forEach((pokemon, entryindex) => {
                            const Pokebtn = document.createElement('button');
                            Pokebtn.innerText = `${pokemon.name}\n(${pokemon.hp}/${pokemon.maxHp})`;
                            Pokebtn.style.padding = '10px';
                            Pokebtn.style.marginRight = '5px';
                            Pokebtn.style.cursor = 'pointer';
                            if(pokemon.status == "FNT")
                                Pokebtn.disabled = true;
                            Pokebtn.onclick = () => {
                                console.log(`[index.html]/[PokeBtn.onclick]: emit 'action' (switch: ${entryindex})`);
                                socket.emit('action', { type: 'switch', index: entryindex });
                            };
                            switchButton.appendChild(Pokebtn);
                        });
                    }
                };
                switchButton.appendChild(Chbtn);

                const Disbtn = document.createElement('button');
                Disbtn.innerText = `ì·¨ì†Œ`;
                Disbtn.style.padding = '10px';
                Disbtn.style.marginRight = '5px';
                Disbtn.style.cursor = 'pointer';
                Disbtn.onclick = () => {
                    if(gameState != 'FORCE_SWITCH'){
                        const buttons = moveButtonsContainer.querySelectorAll('button'); 
                        buttons.forEach(btn => btn.disabled = false);

                        const switchBtns = switchButton.querySelectorAll('button');
                        switchBtns.forEach(btn => btn.disabled = false); // êµì²´ ë²„íŠ¼

                        Disbtn.disabled = true;
                        
                        const li = document.createElement('li');
                        li.style.color = "blue";
                        li.textContent = "ì…ë ¥ì„ ì·¨ì†Œí•˜ì˜€ìŠµë‹ˆë‹¤."
                        messages.appendChild(li);
                        socket.emit('cancel_action');
                    }
                };
                discardButton.appendChild(Disbtn);
                Disbtn.disabled = true;
            }
        });

        socket.on('chat message', (msg) => {
            const item = document.createElement('li');
            item.textContent = msg;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('input_locked', () => {
            const buttons = moveButtonsContainer.querySelectorAll('button'); // >< ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ì½”ë“œ
            buttons.forEach(btn => btn.disabled = true); // í–‰ë™ ë²„íŠ¼
            const switchBtns = switchButton.querySelectorAll('button');
            switchBtns.forEach(btn => btn.disabled = true); // êµì²´ ë²„íŠ¼
            const disBtn = discardButton.querySelectorAll('button');
            disBtn.forEach(btn => btn.disabled = false); // ì·¨ì†Œ ë²„íŠ¼
            const li = document.createElement('li');
            li.style.color = "blue";
            li.textContent = "â³ ì…ë ¥ ì™„ë£Œ! ìƒëŒ€ë°© ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
            messages.appendChild(li);
        });

        socket.on('turn_start', () => {
            const buttons = moveButtonsContainer.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = false); // >< ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ì½”ë“œ

            const switchBtns = switchButton.querySelectorAll('button');
            switchBtns.forEach(btn => btn.disabled = false);
        });

        // [ê³µê²©] ë²„íŠ¼ í´ë¦­ ì‹œ
        btnShowAttack.addEventListener('click', () => {
            attackPanel.style.display = 'block';
            partyPanel.style.display = 'none';
        });

        // [í¬ì¼“ëª¬] ë²„íŠ¼ í´ë¦­ ì‹œ
        btnShowParty.addEventListener('click', () => {
            attackPanel.style.display = 'none';
            partyPanel.style.display = 'block';
        });

        // êµì²´ íŒ¨ë„ ì•ˆì˜ [ì·¨ì†Œ] ë²„íŠ¼
        btnCancelSwitch.addEventListener('click', () => {
            attackPanel.style.display = 'block';
            partyPanel.style.display = 'none';
        });
    </script>
</body>
</html>